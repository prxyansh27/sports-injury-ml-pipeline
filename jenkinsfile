pipeline {
    agent any

    environment {
        VENV_DIR   = "venv"
        MODEL_FILE = "injury_model.pkl"
        APP_PORT   = "5000"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'Checking out source code'
                checkout scm
            }
        }

        stage('Setup Environment') {
            steps {
                echo 'Creating virtual environment'
                bat """
                    python -m venv %VENV_DIR%
                    call %VENV_DIR%\\Scripts\\activate
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                """
            }
        }

        stage('Train Model') {
            steps {
                echo 'Training model'
                bat """
                    call %VENV_DIR%\\Scripts\\activate
                    python train.py
                """
            }
            post {
                success {
                    echo "Model trained successfully"
                    archiveArtifacts artifacts: "injury_model.pkl", fingerprint: true
                }
                failure {
                    echo "Model training failed"
                }
            }
        }

        stage('Verify Model Exists') {
            steps {
                echo 'Checking if model file exists'
                bat """
                    if not exist injury_model.pkl (
                        echo Model file not found!
                        exit /b 1
                    )
                    echo Model file found successfully
                """
            }
        }

        stage('Flask Import Test') {
            steps {
                echo 'Testing Flask app import'
                bat """
                    call %VENV_DIR%\\Scripts\\activate
                    python -c "import app; print('Flask app loaded successfully')"
                """
            }
        }
    }

    post {
        success {
            echo "====================================="
            echo "PIPELINE COMPLETED SUCCESSFULLY"
            echo "====================================="
        }
        failure {
            echo "====================================="
            echo "PIPELINE FAILED - CHECK LOGS ABOVE"
            echo "====================================="
        }
    }
}
